<?xml version="1.0" encoding="utf-8"?>
<InstructionData xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <DateTime>133804148992312135</DateTime>
  <GameVersion>0.2.5370.24111</GameVersion>
  <Title>GFG Management</Title>
  <Description>Manages power sources and displays power related functions.â€‹</Description>
  <Author>SMiLeY.NET</Author>
  <WorkshopFileHandle>0</WorkshopFileHandle>
  <Instructions>### Power Management ###
alias Self db
alias SleepToggle d0

#alias PowerInputAmt r0       # from Cable Analyzer In
#alias PowerOutputAmt r1      # from Cable Analyzer Out
alias CurrentBatteryRatio r1
alias PIDError r2
alias Proportional r3
alias PreviousError r4
alias Integral r5
alias Derivative r6
alias Setpoint r7
alias PIDOutput r8
alias GeneratorActive r12
alias Temp r13
alias OnState r14

# Gains and clamps -- tune as needed
define SetPoint 0.8 # Battery Ratio
define Kp 200 # Proportional Gain
define Ki 40 # Integral Gain
#Ti
define Kd 20 # Derivative Gain
#Td
define MinOutput 0
define MaxOutput 50
define FilterTicks 4 # Try 3-5

define RegulatorMode -1 # Decrease when too high
define SPDeviceMultiplier 1

define MaxIntegral 20    #Integral windup clamp - tune to system
define MinIntegral -20
define DeltaT 0.5
# define MaxGeneratorW 12500

# define CableAnalyzerHash  HASH("StructureCableAnalysizer")
# define CableAnalyzerIn    HASH("Cable Analyzer - Power In")
# define CableAnalyzerOut   HASH("Cable Analyzer - Power Out")
define GasFuelGenerator   HASH("StructureGasGenerator")
define PressureRegulator  HASH("StructurePressureRegulator")
define GFGRegulator       HASH("Pressure Regulator - GFG")
define StationBatteryHash HASH("StructureBattery")

Init:
sbn PressureRegulator GFGRegulator On 1
move PreviousError 0
move Integral 0

Main:
yield
#bdseal SleepToggle HandleSleep
jal HandleFuelGenerator
j Main

HandleSleep:
l OnState SleepToggle Setting
beqz OnState TurnOff
sbn PressureRegulator GFGRegulator On 1
j ra

TurnOff:
sbn PressureRegulator GFGRegulator On 0
j ra


HandleFuelGenerator:
# lb CurrentGeneratorW GasFuelGenerator PowerGeneration Sum
# move Setpoint PowerOutputAmt
#s d0 Setting SetPoint
lb CurrentBatteryRatio StationBatteryHash Ratio Average
# sub PIDError Setpoint PowerInputAmt
sub PIDError SetPoint CurrentBatteryRatio
s d1 Setting PIDError
# ----- PROPORTIONAL -----
move Proportional PIDError
mul Proportional Proportional Kp
s d2 Setting Proportional
# ----- INTEGRAL -----
# I = I + (Ki * e * dt) (clamped)
mul Temp PIDError Ki
mul Temp Temp DeltaT
add Integral Integral Temp
min Integral MaxIntegral Integral
max Integral MinIntegral Integral
s d3 Setting Integral
# ----- DERIVATIVE -----
# D = Kd * (e - e_old) / dt
sub Derivative PIDError PreviousError
div Derivative Derivative DeltaT
mul Derivative Derivative Kd
s d4 Setting Derivative
# ----- SUM PID TERMS -----
move PIDOutput Proportional
add PIDOutput PIDOutput Integral
add PIDOutput PIDOutput Derivative
# Clamp final generator request to [0..12.5] kW
min PIDOutput MaxOutput PIDOutput
max PIDOutput MinOutput PIDOutput
sbn PressureRegulator GFGRegulator Setting PIDOutput
s d5 Setting PIDOutput
s Self Setting PIDOutput
# Disable generator if not needed
sgez GeneratorActive PIDOutput
sb GasFuelGenerator On GeneratorActive
move PreviousError PIDError
j ra</Instructions>
</InstructionData>