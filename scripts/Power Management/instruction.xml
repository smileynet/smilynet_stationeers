<?xml version="1.0" encoding="utf-8"?>
<InstructionData xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <DateTime>133804148992312135</DateTime>
  <GameVersion>0.2.5370.24111</GameVersion>
  <Title>Power Management</Title>
  <Description>Manages power sources and displays power related functions.â€‹</Description>
  <Author>SMiLeY.NET</Author>
  <WorkshopFileHandle>0</WorkshopFileHandle>
  <Instructions>### Power Management ###
alias Self db
# alias CablePowIn d0
# alias CablePowOut d1
# alias DaySensor d2 

# Capacity
alias PowerInputAmt r0
alias PowerOutputAmt r1

# Solar
alias HorizontalAngle r2
alias VerticalAngle r3
alias AdjustedHorizontalAngle r4
alias AdjustedVerticalAngle r5

# PID
alias Error r6
alias Proportional r7
alias PreviousError r8
alias Integral r9
alias Derivative r10
alias Setpoint r11
alias Output r12

alias CurrentGeneratorOutput r13

define Time 1
define ProportionalGain 1
define IntegralGain 1
define DerivativeGain 1

define PressureMin 0
define PressureMax 30000

define PanelHorizontalOffset 180
define PanelVerticalOffset 90

define CableAnalyzerHash HASH("StructureCableAnalysizer")
define CableAnalyzerIn HASH("Cable Analyzer - Power In")
define CableAnalyzerOut HASH("Cable Analyzer - Power Out")
define DaySensorHash HASH("StructureDaylightSensor")
define MediumLEDHash HASH("StructureConsoleLED1x2")
define PowerInLED HASH("LED - Power In")
define PowerOutLED HASH("LED - Power Out")
define GasFuelGenerator HASH("StructureGasGenerator")
define VolumePump HASH("StructureVolumePump")
define GFGPump HASH("Volume Pump - GFG")
define SolarPanelHash HASH("StructureSolarPanelDual")

define PowerMode 2

Init:
sbn MediumLEDHash PowerInLED Mode PowerMode
sbn MediumLEDHash PowerInLED Color Color.Green
sbn MediumLEDHash PowerOutLED Mode PowerMode
sbn MediumLEDHash PowerOutLED Color Color.Red
move PreviousError 0
move Integral 0

Main:
yield
jal HandlePowerConsumption
lbn PowerInputAmt CableAnalyzerHash CableAnalyzerIn PowerActual
sbn MediumLEDHash PowerInLED Setting PowerInputAmt
lbn PowerOutputAmt CableAnalyzerHash CableAnalyzerOut PowerActual
sbn MediumLEDHash PowerOutLED Setting PowerOutputAmt
bdseal DaySensor HandleSolar
j Main

HandlePowerConsumption:
lbn PowerInputAmt CableAnalyzerHash CableAnalyzerIn PowerActual 0
sbn MediumLEDHash PowerInLED Setting PowerInputAmt
lbn PowerOutputAmt CableAnalyzerHash CableAnalyzerOut PowerActual 0
sbn MediumLEDHash PowerOutLED Setting PowerOutputAmt

HandleSolar:
lb HorizontalAngle DaySensorHash Horizontal Maximum
lb VerticalAngle DaySensorHash Vertical Maximum
add AdjustedHorizontalAngle HorizontalAngle PanelHorizontalOffset
sub AdjustedVerticalAngle PanelVerticalOffset VerticalAngle
sb SolarPanelHash Horizontal AdjustedHorizontalAngle
sb SolarPanelHash Vertical AdjustedVerticalAngle
j ra

HandleFuelGenerator:
lb CurrentGeneratorOutput FuelGeneratorHash PowerGeneration Sum
sub Setpoint PowerOutputAmt PowerInputAmt
add Setpoint Setpoint CurrentGeneratorOutput
sub Error Setpoint CurrentGeneratorOutput
move Proportional Error
mul Proportional Proportional ProportionalGain
add Integral Integral Error
mul Integral Integral Time
mul Integral Integral IntegralGain
sub Derivative Error PreviousError
mul Derivative Derivative Time
mul Derivative Derivative DerivativeGain
add Output Proportional Integral
add Ouput Output Derivative
move PreviousError Error
sbn VolumePump GFGPump Setting Output
j ra
</Instructions>
</InstructionData>