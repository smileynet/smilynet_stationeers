<?xml version="1.0" encoding="utf-8"?>
<InstructionData xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <DateTime>133804148992312135</DateTime>
  <GameVersion>0.2.5370.24111</GameVersion>
  <Title>Power Management</Title>
  <Description>Manages power sources and displays power related functions.â€‹</Description>
  <Author>SMiLeY.NET</Author>
  <WorkshopFileHandle>0</WorkshopFileHandle>
  <Instructions>### Power Management ###
alias Self db
# alias CablePowIn d0
# alias CablePowOut d1
# alias DaySensor d2

# Capacity
alias PowerInputAmt r0
alias PowerOutputAmt r1

# Solar
alias HorizontalAngle r2
alias VerticalAngle r3
alias AdjustedHorizontalAngle r4
alias AdjustedVerticalAngle r5

# PID
alias PIDError r6
alias Proportional r7
alias PreviousError r8
alias Integral r9
alias Derivative r10
alias Setpoint r11
alias PIDOutput r12
alias CurrentGeneratorOutput r13
alias WaitTime r14


define PIDTime 1
define ProportionalGain 0.01
define IntegralGain 0.01
define DerivativeGain 0.1

define TickLength 0.5
define BaseOutput 1300

define PanelHorizontalOffset 180
define PanelVerticalOffset 90

define CableAnalyzerHash HASH("StructureCableAnalysizer")
define CableAnalyzerIn HASH("Cable Analyzer - Power In")
define CableAnalyzerOut HASH("Cable Analyzer - Power Out")
define DaySensorHash HASH("StructureDaylightSensor")
define MediumLEDHash HASH("StructureConsoleLED1x2")
define PowerInLED HASH("LED - Power In")
define PowerOutLED HASH("LED - Power Out")
define GasFuelGenerator HASH("StructureGasGenerator")
define VolumePump HASH("StructureVolumePump")
define GFGPump HASH("Volume Pump - GFG")
define PressureRegulator HASH("StructurePressureRegulator")
define GFGRegulator HASH("Pressure Regulator - GFG")
define SolarPanelHash HASH("StructureSolarPanelDual")

define PowerMode 2

Init:
s Self Setting 0
sbn MediumLEDHash PowerInLED Mode PowerMode
sbn MediumLEDHash PowerInLED Color Color.Green
sbn MediumLEDHash PowerOutLED Mode PowerMode
sbn MediumLEDHash PowerOutLED Color Color.Red
sbn PressureRegulator GFGRegulator On 1
sbn VolumePump GFGPump On 0

sb GasFuelGenerator On 1
move WaitTime 0
move PreviousError 0
move Integral 0

Main:
yield
jal HandlePowerConsumption
jal HandleSolar
jal HandleFuelGenerator
j Main

HandlePowerConsumption:
lbn PowerInputAmt CableAnalyzerHash CableAnalyzerIn PowerActual Maximum
sbn MediumLEDHash PowerInLED Setting PowerInputAmt
lbn PowerOutputAmt CableAnalyzerHash CableAnalyzerOut PowerActual Maximum
sbn MediumLEDHash PowerOutLED Setting PowerOutputAmt
j ra

HandleSolar:
lb HorizontalAngle DaySensorHash Horizontal Maximum
lb VerticalAngle DaySensorHash Vertical Maximum
add AdjustedHorizontalAngle HorizontalAngle PanelHorizontalOffset
sub AdjustedVerticalAngle PanelVerticalOffset VerticalAngle
sb SolarPanelHash Horizontal AdjustedHorizontalAngle
sb SolarPanelHash Vertical AdjustedVerticalAngle
j ra

HandleFuelGenerator:
sub WaitTime WaitTime TickLength
j UpdatePID
brlez WaitTime UpdatePID
j ra

UpdatePID:
move WaitTime PIDTime
sb GasFuelGenerator On 1
lb CurrentGeneratorOutput GasFuelGenerator PowerGeneration Sum
sub Setpoint PowerOutputAmt PowerInputAmt
add Setpoint Setpoint CurrentGeneratorOutput
sub PIDError Setpoint CurrentGeneratorOutput
move Proportional PIDError
mul Proportional Proportional ProportionalGain
add Integral Integral PIDError
mul Integral Integral PIDTime
mul Integral Integral IntegralGain
sub Derivative PIDError PreviousError
mul Derivative Derivative PIDTime
mul Derivative Derivative DerivativeGain
add PIDOutput Proportional Integral
add PIDOutput PIDOutput Derivative
#div PIDOutput PIDOutput BaseOutput
s Self Setting PIDOutput
move PreviousError PIDError
#sbn VolumePump GFGPump Setting PIDOutput
sbn PressureRegulator GFGRegulator Setting PIDOutput
j ra</Instructions>
</InstructionData>